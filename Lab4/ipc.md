**IPC** - аббревиатура для ***Interproccess Communaction*** (междупроцессное взаимодействие) и обычно относиться к совокупности механизмов, позволяющих процессу в режиме пользователя делать следующие:
1) Синхронизироваться с другими процессами благодаря семафору
2) Отправлять сообщения другим процессам или получать сообщения от них
3) Разделять область памяти с другими процессами

Структуры данных IPC создают динамически, когда процесс запрашивает IPC ресурс (*resource*), например, **семафор, очередь сообщений, или область общей памяти**. Этот ресурс всегда остается доступным в системе до её выключения(только если не будет специально уничтожен процессом). Он может быть использован любым процессом.

Каждому новому ресурсу присваивается 32-битный IPC ключ, аналогичный путю файла в системном файловом дереве. Каждый ресурс также имеет и 32-битный IPC идентификатор, который похож на файловый дескриптор, соответствующий открытому файлу. Этот идентификатор присваивается ядром и уникален в рамках системы, когда как ключ может быть выбран программистом. Когда 2 или более процесса желают общаться через IPC ресурс, они все обращаются к идентификатору этого ресурса. 

Для создания применять:
семафора - *semget()* или *sem_open()*
очереди сообщений - *msgget()* или *mq_open()*
общей области памяти - *shmget()* или *shm_open()*
Возвращают IPC идентификатор или ошибку по IPC ключу. Если такого нет, то создается новый ресурс. В функции можно передать следующие флаги:
1) IPC_CREAT - ресурс должен быть создан, если ещё не существует
2) IPC_EXCL - функция должна вернуть ошибку, если ресурс уже существует
3) IPC_NOWAIT - процесс никогда не должен блокироваться при доступе к ресурсу.

Если требуется, чтобы два процесса делили один ключ, то есть два способа:
1) Соглашение о ключе (но есть шанс коллизии)
2) Использование IPC_PRIVATE (но нужно как-то передать)

Каждый ресурс владеет структурой данных ipc_ids, которая включает в себя следующие поля:
![[Pasted image 20250504150243.png]]

# Разделяемая память

Самым полезным механизмом IPC можно считать разделяемую память. Он позволяет многим процессам обращаться к некоторым общим структурам данных, располагая их в *IPC shared memory region*. Каждый процесс, который хочет иметь доступ к общим структурам данных, должен добавить в свое адресное пространство новый регион памяти, который мапирует страницы, соответствующие IPC shared memory region.

В System V:

Функция *shmat()* используется, чтобы прикрепить IPC shared memory region к процессу. *shmdt()* - наоборот. 

Каждый регион разделенной памяти ставится в соответствие с файлом, принадлежащим к специальной файловой системе *shm*. У этой системы нет точки монтирования, поэтому никто не может обращаться к её файлом, используя обычные сисколы файловой системы.  

В POSIX:

POSIX позволяет связать с объектом совместно используемой памяти файловый дескриптор, что является более унифицированным механизмом, чем механизм UNIX System V. Для работы с памятью могут быть использованы следующие функции языка C:

shm_open — создание или подключение объекта совместно используемой памяти POSIX по его имени;
shm_unlink — удаление объекта совместно используемой памяти по его имени (при этом сегмент совместно используемой памяти будет существовать, пока не будет отключен от всех процессов);
ftruncate — задаёт или изменяет размер совместно используемой памяти (или отображённого в память файла);
mmap — подключает существующий или создаёт анонимный сегмент совместно используемой памяти к адресному пространству процесса.

Производится отображение их каталога: /dev/shm/ (или /run/shm/) (обычно хранится в RAM).

Лучше всего:
- **POSIX (`shm_open` + `mmap`)** — современно, удобно, поддерживает имена.
- **System V (`shmget`)** — устаревший, но иногда требуется для совместимости.
- **Memfd** — лучший выбор для новых проектов (изоляция, безопасность).

**Такой метод имеет некоторые проблемы:**
1) Race conditions
2) Утечки ресурсов
3) Безопасность (можно влезть в /dev/shm)
4) Ограничение размера и фрагментация

Кроме этого, существуют ещё:
1) Pipes и FIFOs (именованные пайпы)
2) Сокеты
# Pipes


